<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jon√†s Forchini - Salty Territories</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700;800;900&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif;
      overflow: hidden;
      background: #fff;
      color: #000;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    body::-webkit-scrollbar {
      display: none;
    }

    /* Canvas Three.js */
    canvas {
      display: block;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 1;
      pointer-events: none;
    }

    /* Navigation Desktop */
    .main--menu {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 1000;
      pointer-events: none;
    }

    .header {
      position: relative;
      padding: 2rem 0;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      width: 90vw;
      margin: 0 auto;
      pointer-events: auto;
    }

    .name {
      font-size: clamp(0.9rem, 1.2vw, 1.5rem);
      font-weight: 700;
      cursor: pointer;
      transition: opacity 0.3s;
      text-align: center;
      width: 45%;
    }

    .name:hover {
      opacity: 0.7;
    }

    .menu--home {
      width: 30vw;
      position: relative;
    }

    .menu--home > div {
      padding: 0 0 1vh;
    }

    .menu--home .link {
      cursor: pointer;
      font-size: clamp(0.9rem, 1.2vw, 1.5rem);
      font-weight: 700;
      transition: opacity 0.3s;
    }

    .menu--home .link:hover {
      opacity: 0.7;
    }

    .list {
      position: absolute;
      padding-top: 0.5vh;
      opacity: 0;
      pointer-events: none;
      transition: all 0.5s ease;
      background: #fff;
      padding: 1rem;
      min-width: 200px;
    }

    .menu--home:hover .list {
      opacity: 1;
      pointer-events: auto;
    }

    .list span {
      display: block;
      font-weight: 400;
      font-size: clamp(0.8rem, 1vw, 1.2rem);
      cursor: pointer;
      line-height: 1.5;
      padding-bottom: clamp(4px, 0.25vh, 15px);
      text-decoration: underline;
      text-underline-offset: 0.4vh;
      text-decoration-thickness: clamp(1px, 0.12vw, 3px);
      text-decoration-color: transparent;
      transition: all 0.15s ease;
    }

    .list span:hover {
      text-decoration-color: #000;
    }

    .sub--menu {
      padding-top: 1rem !important;
      font-size: clamp(10px, 1.2vw, 180px);
      font-weight: 400;
      opacity: 0.6;
    }

    .header--left, .header--right {
      display: flex;
      writing-mode: vertical-lr;
      position: fixed;
      height: 95vh;
      padding-right: 1vw;
      font-size: clamp(0.5rem, 1.2vw, 1.5rem);
      font-weight: 700;
      z-index: 1000;
      pointer-events: auto;
    }

    .header--left {
      flex-direction: row-reverse;
      transform: rotate(180deg);
      top: 10vh;
      left: 0;
    }

    .header--right {
      flex-direction: unset;
      transform: rotate(0deg);
      top: 10vh;
      right: 0;
    }

    .header--left div, .header--right div {
      padding: 0.5vw;
      cursor: pointer;
      transition: opacity 0.3s;
    }

    .header--left div:hover, .header--right div:hover {
      opacity: 0.7;
    }

    /* Navigation Mobile */
    .menu--mobile {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      padding: 1.5rem;
      justify-content: space-between;
      align-items: center;
      z-index: 1000;
      background: #fff;
      pointer-events: auto;
    }

    .mobile--title {
      font-size: 1.2rem;
      font-weight: 700;
    }

    .burger-menu-toggle {
      width: 30px;
      height: 20px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      cursor: pointer;
    }

    .menu-icon__line {
      width: 100%;
      height: 2px;
      background: #000;
      transition: all 0.3s;
    }

    .burger-menu-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      background: #fff;
      padding: 6rem 2rem 2rem;
      transform: translateY(-100%);
      transition: transform 0.3s;
      z-index: 999;
      overflow-y: auto;
      pointer-events: none;
    }

    .burger-menu-container.active {
      transform: translateY(0);
      pointer-events: auto;
    }

    .burger-menu {
      padding: 2rem 0;
    }

    .main-navigation {
      list-style: none;
    }

    .titre--1 {
      display: block;
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 1rem;
    }

    .titre--2 {
      display: block;
      font-size: 1.2rem;
      font-weight: 600;
      margin-top: 1rem;
      margin-bottom: 0.5rem;
      opacity: 0.7;
    }

    .titre--3 {
      display: block;
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 0.8rem;
    }

    .main-navigation span {
      display: block;
      margin-bottom: 0.8rem;
      cursor: pointer;
      transition: opacity 0.3s;
    }

    .main-navigation span:hover {
      opacity: 0.7;
    }

    .space-top {
      margin-top: 1rem !important;
    }

    /* Hero Section */
    .gallery.vertical {
      position: relative;
      width: 100vw;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10;
    }

    .gallery.vertical.each {
      position: relative;
    }

    .gallery.vertical.text--section {
      background: transparent;
    }

    .words {
      position: relative;
      padding: 6vw;
      width: 100vw;
      text-align: left;
      z-index: 1;
      transition: opacity 0.5s;
    }

    .words span {
      font-size: clamp(3rem, 5.1vw, 8rem);
      font-family: 'Roboto', sans-serif;
      font-weight: 800;
      line-height: 1;
      letter-spacing: 0;
      color: #000;
      text-transform: initial;
    }

    .text--section .words {
      width: 43vw;
      font-size: clamp(0.9rem, 1.5vw, 1.2rem);
      font-family: 'Roboto', sans-serif;
      font-weight: 300;
      line-height: 1.3;
      text-align: justify;
      padding: 0;
    }

    .text--section .words span {
      font-size: inherit;
      font-weight: inherit;
      line-height: inherit;
    }

    /* Image Sections */
    .image--section {
      min-height: 100vh;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      z-index: 10;
    }

    .image--section img {
      max-width: 80vw;
      max-height: 80vh;
      object-fit: contain;
    }

    /* Galerie verticale cach√©e initialement */
    #vertical-gallery {
      opacity: 0;
      transition: opacity 0.5s;
    }

    #vertical-gallery.visible {
      opacity: 1;
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .main--menu {
        display: none;
      }

      .menu--mobile {
        display: flex;
      }

      .words span {
        font-size: clamp(2rem, 8vw, 5rem) !important;
      }

      .text--section .words {
        width: 90vw !important;
        padding: 0 5vw !important;
      }
    }

    @media (max-width: 768px) {
      .header--left,
      .header--right {
        display: none;
      }

      .gallery.vertical {
        padding: 2rem 0;
      }

      .words {
        padding: 2rem;
      }
    }
  </style>
</head>
<body>
  <!-- Navigation Desktop -->
  <div class="main--menu">
    <div class="header">
      <div class="name" id="NAMING">
        <a>Jon√†s Forchini</a>
      </div>

      <div class="menu--home">
        <div class="link">
          <a class="projects2">Projects</a>
        </div>
        <div class="list projects">
          <div class="sub--menu">Practice From the Bottom</div>
          <span class="link goto"><a>An Apprenticeship to Murky Depths</a></span>
          <span class="link goto"><a>Spectrum</a></span>
          <div class="sub--menu">Mangrovines</div>
          <span class="link goto"><a>Salty Territories</a></span>
          <span class="link goto"><a>Area 34</a></span>
          <span class="link goto"><a>On The Ropes</a></span>
        </div>
      </div>

      <div class="menu--home">
        <div class="link">
          <a class="dummys2">Dummys</a>
        </div>
        <div class="list dummys">
          <span class="link goto"><a>Brief history of underwater photography</a></span>
          <span class="link goto" style="margin-top: 1vh;"><a>Mangrovines : Salty Territories</a></span>
          <span class="link goto" style="margin-top: 1vh;"><a>Kancho</a></span>
        </div>
      </div>

      <div class="menu--home last-head">
        <div class="link goto">
          <a>Exhibitions</a>
        </div>
      </div>
    </div>

    <div class="header--right">
      <div class="link goto"><a>About</a></div>
      <div class="link goto"><a>Contact</a></div>
      <div class="link goto"><a>Social Media</a></div>
    </div>

    <div class="header--left">
      <div class="link goto"><a>Prints</a></div>
      <div class="link goto"><a>Portfolio</a></div>
      <div class="link goto"><a>Documentation</a></div>
    </div>
  </div>

  <!-- Navigation Mobile -->
  <div class="menu--mobile">
    <div class="mobile--title">Jon√†s Forchini</div>
    <div class="burger-menu-toggle" onclick="toggleMobileMenu()">
      <span class="menu-icon__line"></span>
      <span class="menu-icon__line"></span>
      <span class="menu-icon__line"></span>
    </div>
  </div>

  <nav class="burger-menu-container" id="LAYER__MENU">
    <div class="burger-menu">
      <ul class="main-navigation">
        <div>
          <li style="padding-top: 15vh;">
            <span class="titre--1">Projects</span>
            <span class="titre--2">Practice from the bottom</span>
            <span class="space-top"><a>An Apprenticeship to Murky Depths</a></span>
            <span><a>Spectrum</a></span>
            <span class="titre--2">Mangrovines</span>
            <span class="space-top"><a>Salty Territories</a></span>
            <span><a>Area 34</a></span>
            <span><a>On The Ropes</a></span>
          </li>
          <div style="margin-top: 5vh;">
            <li>
              <span class="titre--1">Dummys</span>
              <span class="space-top"><a>Brief history of underwater photography</a></span>
              <span><a>Mangrovines : Salty Territories</a></span>
              <span><a>Kancho</a></span>
            </li>
          </div>
        </div>
        <div>
          <div>
            <li><span class="titre--3">Exhibitions</span></li>
          </div>
          <div>
            <li>
              <span class="titre--3"><a>Prints</a></span>
              <span class="titre--3"><a>Portfolio</a></span>
              <span class="titre--3"><a>Documentation</a></span>
            </li>
          </div>
          <div>
            <li>
              <span class="titre--3"><a>About</a></span>
              <span class="titre--3"><a>Contact</a></span>
              <span class="titre--3"><a>Social Media</a></span>
            </li>
          </div>
        </div>
      </ul>
    </div>
  </nav>

  <!-- Main Gallery Content -->
  <div class="main--gallery" id="SALTY_TERRITORIES__PAGE">

    <!-- Hero Section avec titre (IMAGE 01 avec particules en arri√®re-plan) -->
    <section id="GALLERY__VERTICAL" class="gallery vertical each right height-large vertical-center text--section">
      <div class="words">
        <span>Mangrovines:<br>Salty Territories</span>
      </div>
    </section>

    <!-- Galerie verticale (visible apr√®s premier cycle de scroll) -->
    <div id="vertical-gallery">

      <!-- Text Section -->
      <section id="GALLERY__TEXT" class="gallery vertical each center vertical-center text--section" style="background: transparent; padding-top: 21vw; padding-bottom: 19vw;">
        <div class="words">
          <span>The word "Mangrovines" is a lyrical neologism popularized by the Senegalese poet Racine Senghor to designate the inhabitants of the Saloum, Gambia and Casamance deltas in West Africa. Drawing on the underwater roots of the manglar, a key natural element in these river regions, Senghor's collection of poems "Mangrovines" creates a analogy for the deep-rootedness of the sea trades and their values, passed down from one generation to the next. <br><br>A half underwater, half swimming trip along the mouth of the Cassamance Delta. Accompanied by my friend Joe and with a camera slung on our backs, we will go deep into the mangrove forests in search of fish. At the same time it is a journey through the greenish waters and loaded with phytoplankton, which connotes, however, a certain security because these waters are full of life. Although we cannot have a visual access to the bottom, the mangrove roots show us the depth below our feet. With each breath of air, we dive by the head and sink deeper until sometimes touching the ground. The color of the water changes depending on the temperatures and also the winds that affect beyond the surface, making the liquid environment becomes increasingly dense and opaque. Although, before our eyes we have only a few centimeters of visibility, the experience of contemplating the river, takes on a hybrid sense and in constant movement. Each time we go up to the surface and dive back down again. At the same time, we do not stop contouring the edge of the mangroves to be able to orient ourselves, and with the branches we interpret a force of water, stirred by the currents and eddies. The roots protect us, just as they also protect small fish from larger predators.</span>
        </div>
      </section>

      <!-- Image Sections -->
      <section class="gallery vertical each center vertical-center image--section" style="background: transparent; padding-top: 3vw; padding-bottom: 11vw;">
        <img src="./Ressources/IMG_002.jpg" alt="Salty Territories 02" loading="lazy">
      </section>

      <section class="gallery vertical each center vertical-center image--section" style="background: #f5f5f5; padding-top: 3vw; padding-bottom: 11vw;">
        <img src="./Ressources/IMG_003.jpg" alt="Salty Territories 03" loading="lazy">
      </section>

      <section class="gallery vertical each center vertical-center image--section" style="background: transparent; padding-top: 3vw; padding-bottom: 11vw;">
        <img src="./Ressources/IMG_004.jpg" alt="Salty Territories 04" loading="lazy">
      </section>

    </div>
  </div>

  <!-- Three.js Script -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script>
    // ===============================================
    // INTERFACE IMMERSIVE SUBAQUATIQUE
    // ===============================================

    // Mobile Menu Toggle
    function toggleMobileMenu() {
      const burger = document.querySelector('.burger-menu-toggle');
      const mobileNav = document.querySelector('.burger-menu-container');
      burger.classList.toggle('active');
      mobileNav.classList.toggle('active');
    }

    // Initialisation de la sc√®ne Three.js
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);

    // Cr√©er le renderer
    let renderer;
    try {
      renderer = new THREE.WebGLRenderer({
        antialias: true,
        alpha: true,
        preserveDrawingBuffer: false,
        powerPreference: "high-performance"
      });
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.body.insertBefore(renderer.domElement, document.body.firstChild);
    } catch (error) {
      console.error('WebGL error:', error);
      document.body.innerHTML = '<div style="color: black; padding: 20px; font-family: Arial;">WebGL n\'est pas disponible.</div>';
      throw error;
    }

    // Groupe pour les particules
    const sceneGroup = new THREE.Group();
    scene.add(sceneGroup);

    let particles;
    let currentImageIndex = 1;
    const maxImageIndex = 1;

    // Variables pour le zoom progressif
    let zoomLevel = 0;
    let targetZoomLevel = 0;
    const minZoom = -25;
    const maxZoom = -2;

    // Syst√®me de cycle de scroll bidirectionnel
    const MAX_ZOOM_LEVEL = 0.85;
    let scrollPhase = 'zoomIn';
    let hasCompletedFirstCycle = false;

    const textureLoader = new THREE.TextureLoader();

    // Canvas r√©utilisable
    const offscreenCanvas = document.createElement('canvas');
    const offscreenContext = offscreenCanvas.getContext('2d');

    // Cache pour les images
    const imageCache = new Map();
    const IMAGE_VERSION = Date.now();

    // Param√®tres des particules
    let particleParams = {
      density: 0.6,
      disparity: 0.0,
      size: 0.04,
      movement: 0.0,
      saturation: 1.0,
      hideBlack: 0.0,
      randomness: 0.4,
      shape: 'circle',
      movementMode: 2
    };

    // √âtats UX (7 √©tats de zoom)
    let uxJourneyMode = true;
    const uxStates = [
      { name: "√âtat 1", size: 0.04, density: 0.6, disparity: 0, movement: 0, randomness: 0.4, saturation: 1, hideBlack: 0, shape: "circle", movementMode: 2 },
      { name: "√âtat 2", size: 0.04, density: 0.6, disparity: 0.48, movement: 0, randomness: 0.4, saturation: 1, hideBlack: 0, shape: "circle", movementMode: 2 },
      { name: "√âtat 3", size: 0.04, density: 0.6, disparity: 2.5, movement: 0, randomness: 0.4, saturation: 1, hideBlack: 0, shape: "circle", movementMode: 2 },
      { name: "√âtat 4", size: 0.04, density: 0.6, disparity: 2.5, movement: 0, randomness: 0.4, saturation: 1, hideBlack: 0, shape: "circle", movementMode: 2 },
      { name: "√âtat 5", size: 0.04, density: 0.6, disparity: 2.5, movement: 0.07, randomness: 0.4, saturation: 1, hideBlack: 0, shape: "circle", movementMode: 2 },
      { name: "√âtat 6", size: 0.04, density: 0.6, disparity: 2.5, movement: 0.2, randomness: 0.4, saturation: 1, hideBlack: 0, shape: "circle", movementMode: 2 },
      { name: "√âtat 7", size: 0.04, density: 0.6, disparity: 2.77, movement: 0.5, randomness: 0.4, saturation: 1, hideBlack: 0, shape: "circle", movementMode: 2 }
    ];

    // Configuration du scroll
    const scrollConfig = {
      trackpad: {
        sensitivity: 0.000267,
        threshold: 70,
        frequency: 39
      },
      wheel: {
        multiplier: 0.93,
        lerp: 0.22
      },
      global: {
        zoomLerp: 0.18,
        disparityLerp: 0.23
      }
    };

    // Variables pour d√©tection trackpad/molette
    let lastScrollTime = performance.now();
    let wheelScrollAccumulator = 0;

    // Variables pour render optimization
    let hasInitialRender = false;
    let currentAppliedDisparity = 0;
    let lastReloadParams = {};
    let reloadScheduled = false;

    // Fonction de hash d√©terministe
    function seededRandom(x, y, seed = 12345) {
      const combined = (x * 73856093) ^ (y * 19349663) ^ seed;
      const normalized = Math.abs(Math.sin(combined)) * 10000;
      return (normalized % 1000) / 1000;
    }

    // Saturation des couleurs
    function saturateColor(r, g, b, intensity) {
      const avg = (r + g + b) / 3;
      r = avg + (r - avg) * intensity;
      g = avg + (g - avg) * intensity;
      b = avg + (b - avg) * intensity;
      return { r: Math.max(0, Math.min(1, r)), g: Math.max(0, Math.min(1, g)), b: Math.max(0, Math.min(1, b)) };
    }

    // Cr√©er texture de particule
    function createParticleTexture(shape) {
      const size = 128;
      const canvas = document.createElement('canvas');
      canvas.width = size;
      canvas.height = size;
      const ctx = canvas.getContext('2d');

      const centerX = size / 2;
      const centerY = size / 2;

      if (shape === 'circle') {
        const gradient = ctx.createRadialGradient(centerX, centerY, 0, centerX, centerY, size / 2);
        gradient.addColorStop(0, 'rgba(255, 255, 255, 1)');
        gradient.addColorStop(0.5, 'rgba(255, 255, 255, 0.5)');
        gradient.addColorStop(1, 'rgba(255, 255, 255, 0)');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, size, size);
      } else if (shape === 'square') {
        ctx.fillStyle = 'rgba(255, 255, 255, 1)';
        ctx.fillRect(0, 0, size, size);
      }

      const texture = new THREE.CanvasTexture(canvas);
      texture.needsUpdate = true;
      return texture;
    }

    // Charger l'image et cr√©er les particules
    function loadImage(imageIndex) {
      const targetWidth = 1720;
      const targetHeight = 880;

      function buildGeometry(imgData) {
        const scaleFactor = 50;
        const particleGeometry = new THREE.BufferGeometry();

        const particleTexture = createParticleTexture(particleParams.shape);

        const particleMaterial = new THREE.PointsMaterial({
          size: particleParams.size,
          vertexColors: true,
          transparent: true,
          opacity: 1,
          map: particleTexture,
          sizeAttenuation: true,
          depthWrite: false,
          blending: THREE.NormalBlending
        });

        const particleVertices = [];
        const particleColors = [];
        const normalizedDepths = [];

        const step = Math.max(1, Math.floor(1 / particleParams.density));

        for (let y = 0; y < targetHeight; y += step) {
          for (let x = 0; x < targetWidth; x += step) {
            const i = (y * targetWidth + x) * 4;
            let r = imgData.data[i] / 255;
            let g = imgData.data[i + 1] / 255;
            let b = imgData.data[i + 2] / 255;
            const a = imgData.data[i + 3] / 255;

            if (a > 0.5) {
              const saturated = saturateColor(r, g, b, particleParams.saturation);
              r = saturated.r;
              g = saturated.g;
              b = saturated.b;

              const brightness = (r + g + b) / 3;

              if (brightness >= particleParams.hideBlack) {
                let posX = (x - targetWidth / 2) / scaleFactor;
                let posY = (y - targetHeight / 2) / scaleFactor;
                const normalizedDepth = seededRandom(x, y, 3) - 0.5;

                if (particleParams.randomness > 0) {
                  const randomOffsetX = (seededRandom(x, y, 1) - 0.5) * particleParams.randomness * (step / scaleFactor);
                  const randomOffsetY = (seededRandom(x, y, 2) - 0.5) * particleParams.randomness * (step / scaleFactor);
                  posX += randomOffsetX;
                  posY += randomOffsetY;
                }

                particleVertices.push(posX, posY, 0);
                particleColors.push(r, g, b);
                normalizedDepths.push(normalizedDepth);
              }
            }
          }
        }

        particleGeometry.setAttribute('position', new THREE.Float32BufferAttribute(particleVertices, 3));
        particleGeometry.setAttribute('color', new THREE.Float32BufferAttribute(particleColors, 3));
        particleGeometry.setAttribute('normalizedDepth', new THREE.Float32BufferAttribute(normalizedDepths, 1));
        particleGeometry.setAttribute('initialPosition', new THREE.Float32BufferAttribute(particleVertices.slice(), 3));

        if (particles) {
          sceneGroup.remove(particles);
          if (particles.geometry) particles.geometry.dispose();
          if (particles.material) particles.material.dispose();
        }

        particles = new THREE.Points(particleGeometry, particleMaterial);
        particles.rotation.x = Math.PI;
        particles.userData.time = 0;
        sceneGroup.add(particles);

        hasInitialRender = false;
      }

      if (imageCache.has(imageIndex)) {
        const cachedImgData = imageCache.get(imageIndex);
        buildGeometry(cachedImgData);
        return;
      }

      const imagePath = `./Ressources/IMG_${String(imageIndex).padStart(3, '0')}.jpg?v=${IMAGE_VERSION}`;
      textureLoader.load(imagePath, function (texture) {
        offscreenCanvas.width = targetWidth;
        offscreenCanvas.height = targetHeight;

        const srcWidth = texture.image.width;
        const srcHeight = texture.image.height;
        const targetRatio = targetWidth / targetHeight;
        const srcRatio = srcWidth / srcHeight;

        let cropX = 0, cropY = 0, cropWidth = srcWidth, cropHeight = srcHeight;

        if (srcRatio > targetRatio) {
          cropWidth = srcHeight * targetRatio;
          cropX = (srcWidth - cropWidth) / 2;
        } else {
          cropHeight = srcWidth / targetRatio;
          cropY = (srcHeight - cropHeight) / 2;
        }

        offscreenContext.drawImage(
          texture.image,
          cropX, cropY, cropWidth, cropHeight,
          0, 0, targetWidth, targetHeight
        );
        const imgData = offscreenContext.getImageData(0, 0, targetWidth, targetHeight);

        imageCache.set(imageIndex, imgData);
        buildGeometry(imgData);
      }, undefined, function (err) {
        console.error(`Erreur chargement image ${imageIndex}:`, err);
      });
    }

    // Animation loop
    function animate() {
      requestAnimationFrame(animate);

      let needsRender = false;

      if (particles && !hasInitialRender) {
        needsRender = true;
        hasInitialRender = true;
      }

      // PRO WHEEL SMOOTHING: Accumulateur virtuel
      if (Math.abs(wheelScrollAccumulator) > 0.0001) {
        const wheelContribution = wheelScrollAccumulator * scrollConfig.wheel.lerp;

        if (scrollPhase === 'zoomIn') {
          targetZoomLevel += wheelContribution;
        } else if (scrollPhase === 'zoomOut') {
          targetZoomLevel -= wheelContribution;
        }

        targetZoomLevel = Math.max(0, Math.min(MAX_ZOOM_LEVEL, targetZoomLevel));
        wheelScrollAccumulator *= (1 - scrollConfig.wheel.lerp);
      }

      // Cycle bidirectionnel infini
      if (scrollPhase === 'zoomIn' && targetZoomLevel >= MAX_ZOOM_LEVEL - 0.001) {
        scrollPhase = 'zoomOut';
        console.log('üîÑ Phase transition: zoomIn ‚Üí zoomOut');
      } else if (scrollPhase === 'zoomOut' && targetZoomLevel <= 0.001) {
        scrollPhase = 'zoomIn';
        console.log('üîÑ Phase transition: zoomOut ‚Üí zoomIn');

        if (!hasCompletedFirstCycle) {
          hasCompletedFirstCycle = true;
          document.body.style.overflow = 'auto';
          document.getElementById('vertical-gallery').classList.add('visible');
          console.log('‚úÖ Premier cycle termin√© ‚Üí scroll vertical activ√©');
        }
      }

      // Zoom fluide
      if (Math.abs(targetZoomLevel - zoomLevel) > 0.001) {
        zoomLevel += (targetZoomLevel - zoomLevel) * scrollConfig.global.zoomLerp;
        camera.position.z = -minZoom - (-minZoom - maxZoom) * zoomLevel;
        needsRender = true;
      }

      // Calcul des param√®tres selon √©tat UX
      if (uxJourneyMode && uxStates.length >= 2) {
        if (zoomLevel < 0.001) {
          const state1 = uxStates[0];
          particleParams = { ...state1 };

          const needsState1Reload =
            Math.abs(particleParams.density - lastReloadParams.density) > 0.001 ||
            Math.abs(particleParams.randomness - lastReloadParams.randomness) > 0.001 ||
            particleParams.shape !== lastReloadParams.shape;

          if (needsState1Reload && !reloadScheduled) {
            reloadScheduled = true;
            requestAnimationFrame(() => {
              loadImage(currentImageIndex);
              lastReloadParams = { ...state1 };
              reloadScheduled = false;
            });
          }
        } else {
          const normalized = zoomLevel / MAX_ZOOM_LEVEL;
          const exactIndex = normalized * (uxStates.length - 1);
          const lowerIndex = Math.floor(exactIndex);
          const upperIndex = Math.min(lowerIndex + 1, uxStates.length - 1);
          const t = exactIndex - lowerIndex;

          const stateA = uxStates[lowerIndex];
          const stateB = uxStates[upperIndex];

          particleParams.size = stateA.size + (stateB.size - stateA.size) * t;
          particleParams.disparity = stateA.disparity + (stateB.disparity - stateA.disparity) * t;
          particleParams.movement = stateA.movement + (stateB.movement - stateA.movement) * t;

          if (particles && particles.material) {
            particles.material.size = particleParams.size;
            particles.material.needsUpdate = true;
          }
        }
      }

      // Appliquer disparity
      if (particles && particles.geometry) {
        const targetDisparity = particleParams.disparity;

        if (Math.abs(targetDisparity - currentAppliedDisparity) > 0.001) {
          currentAppliedDisparity += (targetDisparity - currentAppliedDisparity) * scrollConfig.global.disparityLerp;

          const positions = particles.geometry.attributes.position.array;
          const normalizedDepths = particles.geometry.attributes.normalizedDepth.array;
          const initialPositions = particles.geometry.attributes.initialPosition.array;

          for (let i = 0; i < normalizedDepths.length; i++) {
            const baseZ = initialPositions[i * 3 + 2];
            const depth = normalizedDepths[i];
            positions[i * 3 + 2] = baseZ + depth * currentAppliedDisparity;
          }

          particles.geometry.attributes.position.needsUpdate = true;
          needsRender = true;
        }
      }

      // Mouvement des particules
      if (particles && particleParams.movement > 0) {
        particles.userData.time += 0.01;
        const positions = particles.geometry.attributes.position.array;
        const initialPositions = particles.geometry.attributes.initialPosition.array;

        for (let i = 0; i < positions.length; i += 3) {
          const initX = initialPositions[i];
          const initY = initialPositions[i + 1];

          if (particleParams.movementMode === 2) {
            positions[i] = initX + Math.sin(particles.userData.time + initY * 10) * particleParams.movement;
            positions[i + 1] = initY + Math.cos(particles.userData.time + initX * 10) * particleParams.movement;
          }
        }

        particles.geometry.attributes.position.needsUpdate = true;
        needsRender = true;
      }

      if (needsRender) {
        renderer.render(scene, camera);
      }
    }

    // Event listener pour scroll
    window.addEventListener('wheel', (event) => {
      if (!hasCompletedFirstCycle) {
        event.preventDefault();
      } else {
        if (Math.abs(targetZoomLevel) > 0.001 && Math.abs(targetZoomLevel - MAX_ZOOM_LEVEL) > 0.001) {
          event.preventDefault();
        }
      }

      const now = performance.now();
      const deltaTime = now - lastScrollTime;
      lastScrollTime = now;

      const absDelta = Math.abs(event.deltaY);
      const isTrackpad = absDelta < scrollConfig.trackpad.threshold || deltaTime < scrollConfig.trackpad.frequency;

      let scrollDelta;
      if (isTrackpad) {
        scrollDelta = event.deltaY * scrollConfig.trackpad.sensitivity;
        wheelScrollAccumulator = 0;

        if (scrollPhase === 'zoomIn') {
          targetZoomLevel += scrollDelta;
        } else if (scrollPhase === 'zoomOut') {
          targetZoomLevel -= scrollDelta;
        }
      } else {
        wheelScrollAccumulator += event.deltaY * scrollConfig.trackpad.sensitivity * scrollConfig.wheel.multiplier;
      }

      targetZoomLevel = Math.max(0, Math.min(MAX_ZOOM_LEVEL, targetZoomLevel));
    }, { passive: false });

    // Resize handler
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    // Initialisation
    camera.position.z = -minZoom;
    loadImage(currentImageIndex);
    animate();

    console.log('üåä Interface immersive subaquatique Salty Territories initialis√©e');
  </script>
</body>
</html>
